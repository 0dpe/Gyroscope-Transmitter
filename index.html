<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
    <div id="status">Ready to connect. Tap the button below to start.</div>
    <button id="permission-btn">Enable Gyroscope Access</button>
    <div id="data">Waiting for data...</div>

    <script>

        const localIP = "192.168.0.0"
        const statusDiv = document.getElementById('status');
        const dataDiv = document.getElementById('data');
        const permissionBtn = document.getElementById('permission-btn');
        let socket = null;

        // Function to connect to the WebSocket server
        function connectWebSocket() {
            // Change the IP to your PC's IP address
            socket = new WebSocket("wss://" + localIP + ":8765");

            socket.onopen = () => {
                statusDiv.textContent = "Connected to WebSocket server";
                statusDiv.style.backgroundColor = "#dff0d8";
                dataDiv.style.display = "block";
            };

            socket.onerror = (error) => {
                statusDiv.textContent = "WebSocket connection error";
                statusDiv.style.backgroundColor = "#f2dede";
                console.error("WebSocket Error:", error);
            };

            socket.onclose = () => {
                statusDiv.textContent = "WebSocket connection closed";
                statusDiv.style.backgroundColor = "#fcf8e3";
                dataDiv.style.display = "none";
            };

            return socket;
        }

        // Function to handle device orientation data
        function handleOrientation(event) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                let data = {
                    alpha: event.alpha, // Rotation around z-axis
                    beta: event.beta,   // Tilt front/back
                    gamma: event.gamma,  // Tilt left/right
                    timestamp: new Date().getTime()
                };
                
                socket.send(JSON.stringify(data));
                
                // Update the data display
                dataDiv.textContent = 'a: ' + Math.round(event.alpha) + 'b: ' + Math.round(event.beta) + 'c: ' + Math.round(event.gamma);
            }
        }

        // Request device orientation permission
        permissionBtn.addEventListener('click', function() {

            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            statusDiv.textContent = "Permission granted! Connecting...";
                            window.addEventListener('deviceorientation', handleOrientation);
                            socket = connectWebSocket();
                        } else {
                            statusDiv.textContent = "Permission denied for device orientation";
                        }
                    })
                    .catch(error => {
                        statusDiv.textContent = "Error requesting permission: " + error;
                        console.error('Error requesting device orientation permission', error);
                    });
            }
        });
    </script>
</body>
</html>